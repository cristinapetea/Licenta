// server/scripts/testRanking.js
require('dotenv').config(); // IMPORTANT: Load .env first!

const mongoose = require('mongoose');
const { getAI } = require('../services/aiTaskPrediction');
const Household = require('../model/Household');
const User = require('../model/User'); // IMPORTANT: Import User model!
const Task = require('../model/Task'); // IMPORTANT: Import Task model!

// Culori pentru terminal
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  gold: '\x1b[33m',
  silver: '\x1b[37m',
  bronze: '\x1b[38;5;208m',
  blue: '\x1b[34m',
  green: '\x1b[32m',
  cyan: '\x1b[36m',
  red: '\x1b[31m'
};

function getMedalEmoji(rank) {
  if (rank === 1) return 'ğŸ¥‡';
  if (rank === 2) return 'ğŸ¥ˆ';
  if (rank === 3) return 'ğŸ¥‰';
  return '  ';
}

function getProgressBar(percentage, width = 30) {
  const filled = Math.round((percentage / 100) * width);
  const empty = width - filled;
  return 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty);
}

function printRanking(rankingData) {
  console.log('\n');
  console.log(colors.bright + colors.cyan + 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' + colors.reset);
  console.log(colors.bright + colors.gold + '           ğŸ†  PERFORMANCE RANKING  ğŸ†' + colors.reset);
  console.log(colors.cyan + 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' + colors.reset);
  console.log(`${colors.blue}Household: ${colors.bright}${rankingData.householdName}${colors.reset}`);
  console.log(`${colors.blue}Generated: ${colors.reset}${new Date(rankingData.trainedOn).toLocaleString()}`);
  console.log(colors.cyan + 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€' + colors.reset);
  console.log('\n');

  rankingData.members.forEach((member, index) => {
    const medal = getMedalEmoji(member.rank);
    const rankColor = member.rank === 1 ? colors.gold : 
                      member.rank === 2 ? colors.silver : 
                      member.rank === 3 ? colors.bronze : colors.reset;
    
    // Header membru
    console.log(rankColor + colors.bright + 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—' + colors.reset);
    console.log(rankColor + `â•‘  ${medal}  ${member.memberName.padEnd(30)} ${member.completedTasks}/${member.totalTasks} tasks (${member.completionRate}%)  â•‘` + colors.reset);
    console.log(rankColor + 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' + colors.reset);
    
    // Progress bar
    const bar = getProgressBar(member.completionRate);
    console.log(`   ${colors.blue}${bar}${colors.reset} ${member.completionRate}%`);
    
    console.log('');
    
    // Stats
    console.log(`   ${colors.green}âœ“${colors.reset} AI Score:     ${colors.bright}${member.aiScore}/100${colors.reset}`);
    console.log(`   ${colors.green}âœ“${colors.reset} Completion:   ${member.completionRate}%`);
    console.log(`   ${colors.green}âœ“${colors.reset} Speed:        ${member.avgSpeed}%`);
    console.log(`   ${colors.green}âœ“${colors.reset} Consistency:  ${member.consistency}%`);
    
    console.log('');
    
    // Top 3 Strengths
    if (member.topStrengths && member.topStrengths.length > 0) {
      console.log(`   ${colors.gold}â­ Top 3 Strengths:${colors.reset}`);
      console.log('');
      
      member.topStrengths.forEach((strength, i) => {
        const position = i + 1;
        console.log(`   ${colors.cyan}${position}.${colors.reset} ${colors.bright}${strength.displayName}${colors.reset}`);
        console.log(`      Score: ${strength.score}/100 â€¢ ${strength.completionRate}% done â€¢ ${strength.onTimeRate}% on-time`);
        
        if (i < member.topStrengths.length - 1) {
          console.log('');
        }
      });
    } else {
      console.log(`   ${colors.red}No category data available yet${colors.reset}`);
    }
    
    // Separator Ã®ntre membri
    if (index < rankingData.members.length - 1) {
      console.log('');
      console.log(colors.cyan + 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€' + colors.reset);
      console.log('');
    }
  });
  
  console.log('\n');
  console.log(colors.cyan + 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' + colors.reset);
  console.log(colors.green + 'âœ…  Ranking generated by AI - Task Success Prediction' + colors.reset);
  console.log(colors.cyan + 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' + colors.reset);
  console.log('\n');
}

async function testRanking() {
  try {
    // Conectare la MongoDB
    console.log('ğŸ”Œ Connecting to MongoDB...');
    console.log('ğŸ“ URI:', process.env.MONGODB_URI || 'mongodb://localhost:27017/household-app');
    
    await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/household-app');
    console.log('âœ… Connected to MongoDB\n');
    
    // GÄƒseÈ™te primul household disponibil
    const household = await Household.findOne().populate('members').populate('owner');
    
    if (!household) {
      console.log('âŒ No household found. Please create one first.');
      console.log('ğŸ’¡ Make sure you are connected to the correct database.');
      console.log('   Current URI:', process.env.MONGODB_URI || 'mongodb://localhost:27017/household-app');
      process.exit(1);
    }
    
    console.log(`ğŸ“‹ Testing ranking for household: ${household.name}`);
    console.log(`ğŸ‘¤ Owner: ${household.owner ? household.owner.name : 'Unknown'}`);
    console.log(`ğŸ‘¥ Members: ${household.members.map(m => m.name).join(', ')}\n`);
    
    // GenereazÄƒ ranking
    const ai = getAI();
    console.log('ğŸ§  Generating AI ranking...\n');
    
    const ranking = await ai.generateRanking(household._id);
    
    // AfiÈ™eazÄƒ ranking frumos
    printRanking(ranking);
    
    // SalveazÄƒ È™i Ã®n JSON pentru debugging
    const fs = require('fs');
    fs.writeFileSync(
      'ranking-output.json', 
      JSON.stringify(ranking, null, 2)
    );
    console.log('ğŸ’¾ Ranking saved to ranking-output.json\n');
    
  } catch (error) {
    console.error('âŒ Error:', error.message);
    console.error(error.stack);
  } finally {
    await mongoose.disconnect();
    console.log('ğŸ‘‹ Disconnected from MongoDB');
    process.exit(0);
  }
}

// RuleazÄƒ testul
if (require.main === module) {
  testRanking();
}

module.exports = { testRanking, printRanking };